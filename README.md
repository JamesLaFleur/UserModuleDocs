# UserModule

## Версия 1.0.0 (для примера, в дальшейшем можно будет указать версию последнего релиза модуля или Release notes с описанием изменений в версиях)

Модуль предоставляет функционал, связанный с пользователем - регистрация пользователя, подтверждение по номеру телефона, получение даннных профиля, обновление профиля и телефона.

*****

### Endpoints

UserController модуля предоставляет следующие эндпоинты:

| Метод | URL | Описание
| --- | --- | --- |
| GET | `/users/profile` | Получение информации о профиле пользователя |
| POST | `/users/phone-confirm/:code` | Подтверждение по номеру телефона (динамический параметр code - код подтверждения, введенный пользователем) |
| GET | `/users/phone-resend` | Повторная отправка кода подтверждения на номер телефона пользователя |
| PUT | `/users/profile` | Обновление данных профиля пользователя |
| PUT | `/users/phone` | Обновление номера телефона пользователя |
| POST | `/users/registration` | Регистрация нового пользователя |

*****

### Описание функционала модуля

 1. **Регистрация пользователя, отправка кода для подтверждения на номер телефона**

    `POST /users/registration`

    *Входные данные:*

    | Параметр | Тип данных | Валидация | Описание |
    | --- | --- | --- | --- |
    | firstname | строка | Обязательный, мин. 2 символа | Имя пользователя |
    | phone | строка | Обязательный | Телефон, русский |
    | email | строка | - - | Email пользователя |
    | password | строка | Минимум 8 символов | Пароль пользователя |

    *Функционал:*

    - Проверяет, существует ли уже пользователь с таким номером телефона, если да - выбрасывает исключение.
    - Создает нового пользователя и сохраняет в базу данных.
    - Отправка кода подтверждения на номер телефона. Для генерации кода используется cryptoService. Создается экземпляр PhoneConfirmation с информацией о коде подтверждения, номере телефона, для которого он сгенерирован и id пользователя. PhoneConfirmation сохраняется в базе данных.

    *Выходные данные:* `**201** Created`

 2. **Повторная отправка кода для подтверждения**

    `GET /users/phone-resend`

    *Входные данные:* Информация о пользователе(UserPayload) из запроса

    ```json
    {
    phone: string;
    id: string;
    companyId: string;
    }
    ```

    *Функционал:* Проверяет наличие сохраненного в базе данных кода подтверждения для пользователя. Если код найден, он используется для повторной отправки. Если код не найден - генерируется новый код подтверждения с помощью cryptoService. Экземпляр PhoneConfirmation сохраняется в базе данных. 

    *Выходные данные:* `**200** OK`

 3. **Подтверждение по номеру телефона**

    `POST /users/phone-confirm/:code`

    *Входные данные:* 
    
        - code: number - введенный пользователем код, отправляется в url запроса
        - тело запроса {
            phone: string 
        } - номер телефона пользователя

    *Функционал:* Проверяет наличие в базе данных полученного кода подтверждения для этого номера телефона. Если код не найден - выбрасывает исключение.
    Если код успешно найден - обновляет информацию о пользователе. Поля phoneConfirm  и active получают значение true;
    Код подтверждения удаляется из БД;
    Вызывается метод authService.login;

    *Выходные данные:* `**200** OK`

    ```json
    { 
        accessToken: string; 
        refreshToken: string 
    }
    ```


 4. **Получение профиля пользователя**

    `GET /users/profile`

    *Входные данные:* Информация о пользователе(UserPayload) из запроса

    ```json
    {
    phone: string;
    id: string;
    companyId: string;
    }
    ```

    *Функционал:* Находит пользователя в базе данных по id. Если в UserPayload было передано значение companyId - находит компанию(используется companyService).

    *Выходные данные:* Информация о пользователе и его текущей компании(поле currentCompany). Если компания не найдена - поле currentCompany имеет значение null.

 5. **Обновление профиля пользователя**

    `PUT /users/profile`

    *Входные данные:* Информация о пользователе(UserPayload) из запроса

    ```json
    {
        phone: string;
        id: string;
        companyId: string;
    }
    ```

    + Тело запроса - обновляемая информация о пользователе:

    ```json
    {
        email: string;
        firstname: string;
        password: string;
    }
    ``` 

    *Функционал:* Находит пользователя в базе данных по id, обновляет значения полей, переданных в теле запроса, возвращает обновленный объект пользователя.

    *Выходные данные:* `**201** Created`, информация о пользователе(с обновленными данными)

 6. **Обновление телефона пользователя**

    `PUT /users/phone`

    *Входные данные:* Информация о пользователе(UserPayload) из запроса

    ```json
    {
        phone: string;
        id: string;
        companyId: string;
    }
    ```

    + Тело запроса - phone - новый телефон пользователя:

    ```json
    {
        phone: string;
    }
    ``` 

    *Функционал:* Находит пользователя в базе данных по id, обновляет значение поля phone, возвращает обновленный объект пользователя.

    *Выходные данные:* `**201** Created`, информация о пользователе(с обновленными данными)

*****

### Зависимости(импортируемые модули):
 - AuthModule
 - CryptoModule
 - CompanyModule
 - TypeOrmModule (UserEntity, PhoneConfirmation)

*****

### Использование:
Чтобы использовать функциональность модуля, импортируйте UsersModule в свой модуль приложения. При выполнении запросов, требующих аутентификации, обеспечте наличие необходимых данных о пользователе.

*****

### Используемый стэк:
 - JavaScript
 - TypeScript
 - NestJS
 - TypeORM